<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Trading Journal</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDMEkiy3VjmLwCvIiTJRicXI9jxmkDELrk",
            authDomain: "my-trading-journal-deffe.firebaseapp.com",
            projectId: "my-trading-journal-deffe",
            storageBucket: "my-trading-journal-deffe.firebasestorage.app",
            messagingSenderId: "264398734800",
            appId: "1:264398734800:web:74c6c6c5aef692424825d5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const FINNHUB_KEY = "d5om819r01qjast7ji4gd5om819r01qjast7ji50";

        // --- STATE ---
        let trades = [];
        let portfolioSettings = { startBalance: 100000 }; 
        let winLossChart, plChart;

        // --- LISTENERS ---
        // 1. Listen for Trades
        const q = query(collection(db, "trades"), orderBy("date", "desc"));
        onSnapshot(q, (snap) => {
            trades = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            updateDashboard();
        });

        // 2. Listen for Portfolio Settings
        onSnapshot(doc(db, "settings", "config"), (doc) => {
            if (doc.exists()) portfolioSettings = doc.data();
            updateDashboard();
        });

        // --- CORE FUNCTIONS ---
        
        // Save Trade (New or Edit)
        window.saveTrade = async () => {
            const file = document.getElementById('tImage').files[0];
            let base64 = null;
            if(file) {
                base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result);
                    reader.readAsDataURL(file);
                });
            }

            const id = document.getElementById('editTradeId').value;
            const tradeData = {
                symbol: document.getElementById('tSymbol').value.toUpperCase(),
                entryPrice: parseFloat(document.getElementById('tEntry').value),
                qty: parseFloat(document.getElementById('tQty').value),
                stopLoss: parseFloat(document.getElementById('tStop').value),
                notes: document.getElementById('tNotes').value,
                date: id ? trades.find(t=>t.id===id).date : new Date().toISOString(),
                status: id ? trades.find(t=>t.id===id).status : 'Open',
                livePrice: parseFloat(document.getElementById('tEntry').value), // Default to entry
                avgExitPrice: id ? trades.find(t=>t.id===id).avgExitPrice : 0,
                exitDate: id ? trades.find(t=>t.id===id).exitDate : null
            };

            if(base64) tradeData.image = base64;

            if(id) {
                await updateDoc(doc(db, "trades", id), tradeData);
            } else {
                await addDoc(collection(db, "trades"), tradeData);
            }
            toggleModal('tradeModal');
        };

        // Update Portfolio Balance
        window.saveSettings = async () => {
            const bal = parseFloat(document.getElementById('setBalance').value);
            await setDoc(doc(db, "settings", "config"), { startBalance: bal });
            toggleModal('settingsModal');
        };

        // Update Live Prices
        window.refreshPrices = async () => {
            const btn = document.getElementById('refreshBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Updating...";
            
            for(let t of trades) {
                if(t.status === 'Open') {
                    try {
                        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${t.symbol}&token=${FINNHUB_KEY}`);
                        const data = await res.json();
                        if(data.c) await updateDoc(doc(db, "trades", t.id), { livePrice: data.c });
                    } catch(e) { console.error(e); }
                }
            }
            btn.innerHTML = originalText;
        };

        // Close / Partial
        window.executeClose = async (isFull) => {
            const id = document.getElementById('manageId').value;
            const price = parseFloat(document.getElementById('exitPrice').value);
            const qty = parseFloat(document.getElementById('exitQty').value);
            const t = trades.find(x => x.id === id);

            if(isFull || qty >= t.qty) {
                await updateDoc(doc(db, "trades", id), { 
                    status: 'Closed', 
                    avgExitPrice: price, 
                    exitDate: new Date().toISOString() 
                });
            } else {
                // Partial: Reduce qty
                await updateDoc(doc(db, "trades", id), { qty: t.qty - qty });
            }
            toggleModal('partialModal');
        };

        window.deleteTrade = async (id) => {
            if(confirm("Delete this trade record?")) await deleteDoc(doc(db, "trades", id));
        };

        // PDF Export
        window.exportPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text("Trading Journal Export", 14, 20);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 28);

            const tableData = trades.map(t => [
                t.date.substring(0,10),
                t.symbol,
                t.status,
                t.entryPrice,
                t.status === 'Closed' ? t.avgExitPrice : t.livePrice,
                t.qty,
                (t.status === 'Closed' ? (t.avgExitPrice - t.entryPrice)*t.qty : (t.livePrice - t.entryPrice)*t.qty).toFixed(2)
            ]);

            doc.autoTable({
                head: [['Date', 'Symbol', 'Status', 'Entry', 'Exit/Live', 'Qty', 'P/L $']],
                body: tableData,
                startY: 35,
            });

            doc.save("trading_journal.pdf");
        };

        // --- DASHBOARD CALCULATION & RENDER ---
        function updateDashboard() {
            // 1. Calculate Portfolio Stats
            let totalRealizedPL = 0;
            let totalOpenPL = 0;
            let totalOpenHeat = 0;
            let totalExposure = 0;
            let wins = [], losses = [];

            trades.forEach(t => {
                const isClosed = t.status === 'Closed';
                const curPrice = isClosed ? t.avgExitPrice : (t.livePrice || t.entryPrice);
                const pl = (curPrice - t.entryPrice) * t.qty;
                const plPct = ((curPrice - t.entryPrice) / t.entryPrice) * 100;
                const holdDays = t.exitDate ? (new Date(t.exitDate) - new Date(t.date))/(1000*60*60*24) : 0;

                if(isClosed) {
                    totalRealizedPL += pl;
                    if(pl > 0) wins.push({pl, plPct, holdDays});
                    else losses.push({pl, plPct, holdDays});
                } else {
                    totalOpenPL += pl;
                    totalExposure += (t.entryPrice * t.qty);
                    // Open Heat: If stops were hit right now, what is the loss from CURRENT price?
                    // Or standard definition: Entry - Stop. Let's use User's "Current Price - Stop".
                    totalOpenHeat += (curPrice - t.stopLoss) * t.qty; 
                }
            });

            const startBal = portfolioSettings.startBalance || 100000;
            const currEquity = startBal + totalRealizedPL + totalOpenPL;
            const exposurePct = (totalExposure / currEquity) * 100;

            // Update Header
            document.getElementById('dEquity').innerText = `$${currEquity.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('dBalance').innerText = `$${(startBal + totalRealizedPL).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('dOpenPL').innerHTML = `<span class="${totalOpenPL >= 0 ? 'text-green-400' : 'text-red-400'}">$${totalOpenPL.toFixed(2)}</span>`;
            document.getElementById('dHeat').innerText = `$${totalOpenHeat.toFixed(2)}`;
            document.getElementById('dExp').innerText = `${exposurePct.toFixed(1)}%`;

            // 2. Advanced Stats (Win/Loss, RRR, Avgs)
            const nWins = wins.length;
            const nLoss = losses.length;
            const totalTrades = nWins + nLoss;
            const winRate = totalTrades ? ((nWins/totalTrades)*100).toFixed(1) : 0;
            
            const avgWin = nWins ? wins.reduce((a,b)=>a+b.pl,0)/nWins : 0;
            const avgLoss = nLoss ? losses.reduce((a,b)=>a+b.pl,0)/nLoss : 0;
            const avgWinPct = nWins ? wins.reduce((a,b)=>a+b.plPct,0)/nWins : 0;
            const avgLossPct = nLoss ? losses.reduce((a,b)=>a+b.plPct,0)/nLoss : 0;
            const rrr = avgLoss !== 0 ? Math.abs(avgWin / avgLoss).toFixed(2) : '0';
            
            const avgHoldWin = nWins ? wins.reduce((a,b)=>a+b.holdDays,0)/nWins : 0;
            const avgHoldLoss = nLoss ? losses.reduce((a,b)=>a+b.holdDays,0)/nLoss : 0;

            const largestWin = nWins ? Math.max(...wins.map(w=>w.pl)) : 0;
            const largestLoss = nLoss ? Math.min(...losses.map(w=>w.pl)) : 0;

            // Inject Stats
            const statHTML = `
                <div class="stat-box"><div>Win Rate</div><div class="text-xl text-blue-400 font-bold">${winRate}%</div></div>
                <div class="stat-box"><div>RRR</div><div class="text-xl font-bold">${rrr}</div></div>
                <div class="stat-box"><div>Trades</div><div class="text-xl font-bold">${totalTrades}</div></div>
                <div class="stat-box"><div>Avg Win $</div><div class="text-green-400 font-bold">$${avgWin.toFixed(0)}</div></div>
                <div class="stat-box"><div>Avg Loss $</div><div class="text-red-400 font-bold">$${avgLoss.toFixed(0)}</div></div>
                <div class="stat-box"><div>Avg Win %</div><div class="text-green-400 font-bold">${avgWinPct.toFixed(1)}%</div></div>
                <div class="stat-box"><div>Avg Loss %</div><div class="text-red-400 font-bold">${avgLossPct.toFixed(1)}%</div></div>
                <div class="stat-box"><div>Max Win</div><div class="text-green-400 font-bold">$${largestWin.toFixed(0)}</div></div>
                <div class="stat-box"><div>Max Loss</div><div class="text-red-400 font-bold">$${largestLoss.toFixed(0)}</div></div>
                <div class="stat-box"><div>Hold (Win)</div><div class="font-bold">${avgHoldWin.toFixed(1)}d</div></div>
                <div class="stat-box"><div>Hold (Loss)</div><div class="font-bold">${avgHoldLoss.toFixed(1)}d</div></div>
            `;
            document.getElementById('advancedStats').innerHTML = statHTML;

            // 3. Render Chart
            updateChart(nWins, nLoss);

            // 4. Render Table
            const tbody = document.getElementById('tradeTable');
            tbody.innerHTML = trades.map(t => {
                const isClosed = t.status === 'Closed';
                const cur = isClosed ? t.avgExitPrice : (t.livePrice || t.entryPrice);
                const pl = (cur - t.entryPrice) * t.qty;
                const plPct = ((cur - t.entryPrice) / t.entryPrice) * 100;
                
                return `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50 transition text-sm">
                    <td class="p-3 font-bold text-blue-400">${t.symbol}</td>
                    <td class="p-3 hidden md:table-cell text-gray-500 text-xs">${t.date.substring(0,10)}</td>
                    <td class="p-3">$${t.entryPrice}</td>
                    <td class="p-3 font-mono ${isClosed ? 'text-gray-500':'text-white'}">${isClosed ? '$'+t.avgExitPrice : '$'+cur.toFixed(2)}</td>
                    <td class="p-3">${t.qty}</td>
                    <td class="p-3 font-bold ${pl>=0?'text-green-500':'text-red-500'}">$${pl.toFixed(0)}</td>
                    <td class="p-3 ${plPct>=0?'text-green-500':'text-red-500'}">${plPct.toFixed(1)}%</td>
                    <td class="p-3"><span class="px-2 py-0.5 rounded text-[10px] uppercase font-bold ${isClosed?'bg-gray-700 text-gray-300':'bg-blue-900 text-blue-300'}">${t.status}</span></td>
                    <td class="p-3 flex gap-2">
                        ${!isClosed ? `<button onclick="openManage('${t.id}')" class="icon-btn text-blue-400"><i data-lucide="scissors" size="16"></i></button>`:''}
                        <button onclick="openEdit('${t.id}')" class="icon-btn text-gray-400"><i data-lucide="edit-3" size="16"></i></button>
                        ${t.image ? `<button onclick="viewImage('${t.id}')" class="icon-btn text-orange-400"><i data-lucide="image" size="16"></i></button>` : ''}
                    </td>
                </tr>`;
            }).join('');
            
            lucide.createIcons();
        }

        // Charts
        function updateChart(wins, losses) {
            const ctx = document.getElementById('winLossChart').getContext('2d');
            if(winLossChart) winLossChart.destroy();
            winLossChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Win', 'Loss'], datasets: [{ data: [wins, losses], backgroundColor: ['#22c55e', '#ef4444'], borderWidth: 0 }] },
                options: { cutout: '75%', plugins: { legend: { display: false } } }
            });
        }

        // Helpers
        window.toggleModal = (id) => {
            const el = document.getElementById(id);
            if(el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                el.classList.add('flex');
            } else {
                el.classList.add('hidden');
                el.classList.remove('flex');
            }
        };

        window.openEdit = (id) => {
            document.getElementById('editTradeId').value = id || '';
            document.getElementById('modalTitle').innerText = id ? 'Edit Trade' : 'New Trade';
            if(id) {
                const t = trades.find(x=>x.id===id);
                document.getElementById('tSymbol').value = t.symbol;
                document.getElementById('tEntry').value = t.entryPrice;
                document.getElementById('tQty').value = t.qty;
                document.getElementById('tStop').value = t.stopLoss;
                document.getElementById('tNotes').value = t.notes || '';
            } else {
                ['tSymbol','tEntry','tQty','tStop','tNotes','tImage'].forEach(k=>document.getElementById(k).value='');
            }
            toggleModal('tradeModal');
        };

        window.openManage = (id) => {
            document.getElementById('manageId').value = id;
            toggleModal('partialModal');
        };
        
        window.openSettings = () => {
            document.getElementById('setBalance').value = portfolioSettings.startBalance;
            toggleModal('settingsModal');
        }

        window.viewImage = (id) => {
            const t = trades.find(x => x.id === id);
            const w = window.open("");
            w.document.write(`<img src="${t.image}" style="width:100%">`);
        };

        // Initialize Icons
        lucide.createIcons();
    </script>

    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; font-size: 14px; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 1rem; }
        .stat-box { background: #0f172a; border-radius: 0.5rem; padding: 0.75rem; text-align: center; font-size: 0.8rem; border: 1px solid #1e293b; color: #94a3b8; }
        .input-field { background: #0f172a; border: 1px solid #334155; color: white; padding: 0.5rem; border-radius: 0.375rem; width: 100%; margin-top: 0.25rem; }
        .icon-btn:hover { transform: scale(1.1); transition: 0.2s; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-[1600px] mx-auto">

    <!-- HEADER -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="bar-chart-2" class="text-blue-500"></i> TraderPro</h1>
        <div class="flex gap-2">
            <button onclick="openSettings()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded text-gray-300 flex items-center gap-2 font-medium"><i data-lucide="settings" size="14"></i> Settings</button>
            <button id="refreshBtn" onclick="refreshPrices()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded text-blue-400 flex items-center gap-2 font-medium"><i data-lucide="refresh-cw" size="14"></i> Live Prices</button>
            <button onclick="exportPDF()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded text-gray-300 flex items-center gap-2 font-medium"><i data-lucide="download" size="14"></i> PDF</button>
            <button onclick="openEdit()" class="bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded text-white font-bold flex items-center gap-2"><i data-lucide="plus" size="16"></i> New Trade</button>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
        
        <!-- 1. PORTFOLIO SUMMARY -->
        <div class="card space-y-4">
            <h3 class="text-gray-400 text-xs font-bold uppercase">Portfolio Overview</h3>
            <div class="flex justify-between items-end">
                <span class="text-sm text-gray-400">Equity</span>
                <span id="dEquity" class="text-3xl font-bold text-white">$100,000</span>
            </div>
            <div class="flex justify-between border-t border-gray-700 pt-2 text-sm">
                <span class="text-gray-500">Cash Balance</span>
                <span id="dBalance" class="text-gray-300">$100,000</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-500">Open P/L</span>
                <span id="dOpenPL">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-500">Open Heat (Risk)</span>
                <span id="dHeat" class="text-red-400">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-500">Exposure</span>
                <span id="dExp" class="text-orange-400">0%</span>
            </div>
        </div>

        <!-- 2. WIN/LOSS VISUAL -->
        <div class="card flex flex-col items-center justify-center">
            <h3 class="text-gray-400 text-xs font-bold uppercase mb-2">Win / Loss Ratio</h3>
            <div class="w-32 h-32">
                <canvas id="winLossChart"></canvas>
            </div>
        </div>

        <!-- 3. DETAILED STATS GRID -->
        <div class="lg:col-span-2 card">
            <h3 class="text-gray-400 text-xs font-bold uppercase mb-3">Performance Metrics</h3>
            <div id="advancedStats" class="grid grid-cols-4 gap-2">
                <!-- Stats injected by JS -->
            </div>
        </div>
    </div>

    <!-- TRADE LIST -->
    <div class="card !p-0 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-800 text-gray-400 text-xs uppercase font-semibold">
                    <tr>
                        <th class="p-3">Ticker</th>
                        <th class="p-3 hidden md:table-cell">Date</th>
                        <th class="p-3">Entry</th>
                        <th class="p-3">Current</th>
                        <th class="p-3">Qty</th>
                        <th class="p-3">P/L $</th>
                        <th class="p-3">P/L %</th>
                        <th class="p-3">Status</th>
                        <th class="p-3">Actions</th>
                    </tr>
                </thead>
                <tbody id="tradeTable">
                    <!-- Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-sm">
            <h2 class="font-bold text-lg mb-4">Portfolio Settings</h2>
            <label class="text-xs text-gray-400">Starting Balance ($)</label>
            <input type="number" id="setBalance" class="input-field mb-4">
            <div class="flex gap-2">
                <button onclick="saveSettings()" class="flex-1 bg-green-600 py-2 rounded font-bold">Save</button>
                <button onclick="toggleModal('settingsModal')" class="flex-1 bg-gray-700 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <!-- TRADE MODAL -->
    <div id="tradeModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg">
            <input type="hidden" id="editTradeId">
            <h2 id="modalTitle" class="font-bold text-lg mb-4">Trade Details</h2>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div><label class="text-xs text-gray-400">Symbol</label><input id="tSymbol" class="input-field uppercase" type="text"></div>
                <div><label class="text-xs text-gray-400">Quantity</label><input id="tQty" class="input-field" type="number"></div>
                <div><label class="text-xs text-gray-400">Entry Price</label><input id="tEntry" class="input-field" type="number" step="0.01"></div>
                <div><label class="text-xs text-gray-400">Stop Loss</label><input id="tStop" class="input-field" type="number" step="0.01"></div>
            </div>
            <div class="mb-3">
                <label class="text-xs text-gray-400">Chart Screenshot</label>
                <input id="tImage" type="file" class="block w-full text-xs text-gray-400 mt-1">
            </div>
            <div class="mb-4">
                <label class="text-xs text-gray-400">Notes / Setup</label>
                <textarea id="tNotes" class="input-field h-24"></textarea>
            </div>
            <div class="flex gap-2">
                <button onclick="saveTrade()" class="flex-1 bg-blue-600 py-2 rounded font-bold">Save Record</button>
                <button onclick="toggleModal('tradeModal')" class="flex-1 bg-gray-700 py-2 rounded">Cancel</button>
                <button onclick="deleteTrade(document.getElementById('editTradeId').value); toggleModal('tradeModal');" class="bg-red-900/50 text-red-500 px-3 rounded"><i data-lucide="trash-2" size="16"></i></button>
            </div>
        </div>
    </div>

    <!-- PARTIAL MODAL -->
    <div id="partialModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
        <div class="card w-72 text-center">
            <input type="hidden" id="manageId">
            <h3 class="font-bold mb-4">Manage Position</h3>
            <input type="number" id="exitPrice" placeholder="Exit Price" class="input-field mb-2">
            <input type="number" id="exitQty" placeholder="Shares to Close" class="input-field mb-4">
            <button onclick="executeClose(false)" class="w-full bg-blue-600 py-2 rounded font-bold mb-2">Partial Close</button>
            <button onclick="executeClose(true)" class="w-full bg-red-600 py-2 rounded font-bold mb-2">Full Close</button>
            <button onclick="toggleModal('partialModal')" class="w-full bg-gray-700 py-2 rounded">Cancel</button>
        </div>
    </div>

</body>
</html>
