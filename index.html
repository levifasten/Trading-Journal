<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Trading Journal v7</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDMEkiy3VjmLwCvIiTJRicXI9jxmkDELrk",
            authDomain: "my-trading-journal-deffe.firebaseapp.com",
            projectId: "my-trading-journal-deffe",
            storageBucket: "my-trading-journal-deffe.firebasestorage.app",
            messagingSenderId: "264398734800",
            appId: "1:264398734800:web:74c6c6c5aef692424825d5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const FINNHUB_KEY = "d5om819r01qjast7ji4gd5om819r01qjast7ji50";

        // --- STATE ---
        let trades = [];
        let settings = { startBalance: 100000, adjustments: 0 }; 
        let currentEquity = 100000;
        let winLossChart, avgRetChart;
        let filterType = 'ALL';

        // --- LISTENERS ---
        const q = query(collection(db, "trades"), orderBy("date", "desc"));
        onSnapshot(q, (snap) => {
            trades = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            updateDashboard();
        });

        onSnapshot(doc(db, "settings", "config"), (doc) => {
            if (doc.exists()) {
                settings = { ...settings, ...doc.data() };
                updateDashboard();
            }
        });

        // --- CORE FUNCTIONS ---

        const compressImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
        });

        // SAVE TRADE
        window.saveTrade = async () => {
            try {
                const saveBtn = document.getElementById('saveTradeBtn');
                saveBtn.innerText = "Saving...";
                saveBtn.disabled = true;

                const file = document.getElementById('tImage').files[0];
                let base64 = null;
                if(file) base64 = await compressImage(file);

                const id = document.getElementById('editTradeId').value;
                const dir = document.getElementById('tDirection').value;
                const dateVal = document.getElementById('tDate').value || new Date().toISOString();

                const entry = parseFloat(document.getElementById('tEntry').value);
                const qty = parseFloat(document.getElementById('tQty').value);
                
                if(isNaN(entry) || isNaN(qty)) {
                    alert("Please enter valid numbers for Price and Quantity");
                    return;
                }

                const existing = id ? trades.find(t => t.id === id) : null;

                const tradeData = {
                    symbol: document.getElementById('tSymbol').value.toUpperCase(),
                    direction: dir,
                    entryPrice: entry,
                    qty: qty,
                    stopLoss: parseFloat(document.getElementById('tStop').value) || 0,
                    notes: document.getElementById('tNotes').value || "",
                    date: new Date(dateVal).toISOString(),
                    status: existing ? existing.status : 'Open',
                    livePrice: entry,
                    avgExitPrice: existing?.avgExitPrice || 0,
                    exitDate: existing?.exitDate || null,
                    entryImage: base64 || (existing?.entryImage || null),
                    exitImage: existing?.exitImage || null
                };

                if(id) await updateDoc(doc(db, "trades", id), tradeData);
                else await addDoc(collection(db, "trades"), tradeData);
                
                toggleModal('tradeModal');
            } catch(e) {
                console.error(e);
                alert("Error saving: " + e.message);
            } finally {
                const saveBtn = document.getElementById('saveTradeBtn');
                saveBtn.innerText = "Save Record";
                saveBtn.disabled = false;
            }
        };

        window.executeClose = async (isFull) => {
            const id = document.getElementById('manageId').value;
            const price = parseFloat(document.getElementById('exitPrice').value);
            const qty = parseFloat(document.getElementById('exitQty').value);
            const dateVal = document.getElementById('exitDate').value || new Date().toISOString();
            const file = document.getElementById('exitImageFile').files[0];
            
            let exitImg = null;
            if(file) exitImg = await compressImage(file);

            const t = trades.find(x => x.id === id);
            const updateData = {};

            if(isFull || qty >= t.qty) {
                updateData.status = 'Closed';
                updateData.avgExitPrice = price;
                updateData.exitDate = new Date(dateVal).toISOString();
                if(exitImg) updateData.exitImage = exitImg;
            } else {
                updateData.qty = t.qty - qty;
            }

            await updateDoc(doc(db, "trades", id), updateData);
            toggleModal('partialModal');
        };

        // CALCULATOR LOGIC
        window.updateCalculator = () => {
            const entry = parseFloat(document.getElementById('calcEntry').value);
            const stop = parseFloat(document.getElementById('calcStop').value);
            const fixedRisk = parseFloat(document.getElementById('calcFixedRisk').value);
            const posPct = parseFloat(document.getElementById('calcPosPct').value);
            
            if (!entry) return;

            // 1. Calculate Stop %
            let riskPerShare = 0;
            if(stop) {
                riskPerShare = Math.abs(entry - stop);
                const stopPct = (riskPerShare / entry) * 100;
                document.getElementById('calcSLPct').innerText = stopPct.toFixed(2) + '%';
            } else {
                document.getElementById('calcSLPct').innerText = '0.00%';
            }
            
            // 2. Standard Table
            const fillRow = (pct, idSuffix) => {
                if(!stop) {
                    document.getElementById(`share${idSuffix}`).innerText = '-';
                    return;
                }
                const riskAmount = currentEquity * (pct / 100);
                const shares = Math.floor(riskAmount / riskPerShare);
                document.getElementById(`risk${idSuffix}`).innerText = `$${riskAmount.toFixed(0)}`;
                document.getElementById(`share${idSuffix}`).innerText = shares;
            };

            fillRow(1.00, '100');
            fillRow(0.50, '050');
            fillRow(0.25, '025');

            // 3. Custom Fixed Risk ($)
            if(fixedRisk && stop) {
                const shares = Math.floor(fixedRisk / riskPerShare);
                document.getElementById('resFixedRiskShares').innerText = shares + " shares";
            } else {
                document.getElementById('resFixedRiskShares').innerText = "-";
            }

            // 4. Custom Position Size (%)
            if(posPct) {
                const totalCapital = currentEquity * (posPct / 100);
                const shares = Math.floor(totalCapital / entry);
                document.getElementById('resPosPctShares').innerText = shares + " shares";
                document.getElementById('resPosPctAmt').innerText = `($${totalCapital.toFixed(0)})`;
            } else {
                document.getElementById('resPosPctShares').innerText = "-";
                document.getElementById('resPosPctAmt').innerText = "";
            }
        };

        // FILTER LOGIC
        function getFilteredTrades() {
            const now = new Date();
            let filtered = [];
            const validTrades = trades.filter(t => t.date && !isNaN(new Date(t.date).getTime()));

            if (filterType === 'CUST_NUM') {
                const num = parseInt(document.getElementById('filterNum').value) || 20;
                return validTrades.slice(0, num);
            }

            if (filterType !== 'ALL') {
                filtered = validTrades.filter(t => {
                    const d = new Date(t.date);
                    if (filterType === '7D') return (now - d) / (1000*60*60*24) <= 7;
                    if (filterType === '30D') return (now - d) / (1000*60*60*24) <= 30;
                    if (filterType === 'MTD') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (filterType === 'YTD') return d.getFullYear() === now.getFullYear();
                    if (filterType === '12M') return (now - d) / (1000*60*60*24) <= 365;
                    if (filterType === 'CUST_DATE') {
                        const start = new Date(document.getElementById('filterStart').value);
                        const end = new Date(document.getElementById('filterEnd').value);
                        return d >= start && d <= end;
                    }
                    return true;
                });
            } else {
                filtered = validTrades;
            }
            return filtered;
        }

        window.setFilter = (type) => {
            filterType = type;
            document.getElementById('customDateInputs').classList.add('hidden');
            document.getElementById('customNumInput').classList.add('hidden');
            if(type === 'CUST_DATE') document.getElementById('customDateInputs').classList.remove('hidden');
            if(type === 'CUST_NUM') document.getElementById('customNumInput').classList.remove('hidden');
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
            document.getElementById(`btn-${type}`).classList.add('bg-blue-600', 'text-white');
            document.getElementById(`btn-${type}`).classList.remove('text-gray-400');
            updateDashboard();
        };

        function updateDashboard() {
            let totalRealizedALL = 0, totalOpenALL = 0, totalOpenHeatDollars = 0, totalExp = 0;

            trades.forEach(t => {
                try {
                    if(!t.entryPrice || !t.qty || !t.date) return;
                    const isLong = t.direction !== 'Short';
                    const cur = t.status === 'Closed' ? (t.avgExitPrice || t.entryPrice) : (t.livePrice || t.entryPrice);
                    let pl = isLong ? (cur - t.entryPrice) * t.qty : (t.entryPrice - cur) * t.qty;
                    
                    if (t.status === 'Closed') {
                        totalRealizedALL += pl;
                    } else {
                        totalOpenALL += pl;
                        totalExp += (t.entryPrice * t.qty);
                        let riskPerShare = Math.abs(t.entryPrice - (t.stopLoss || t.entryPrice));
                        totalOpenHeatDollars += (riskPerShare * t.qty);
                    }
                } catch(e) { console.warn("Skipped bad trade", t.id); }
            });

            const startBal = settings.startBalance;
            const adjs = settings.adjustments || 0;
            currentEquity = startBal + adjs + totalRealizedALL + totalOpenALL; // Update global
            const cash = startBal + adjs + totalRealizedALL;

            // Trigger calc update if values exist
            window.updateCalculator();

            const displayTrades = getFilteredTrades();
            let statWins = [], statLosses = [];
            
            const rows = displayTrades.map(t => {
                try {
                    const isLong = t.direction !== 'Short';
                    const isClosed = t.status === 'Closed';
                    const cur = isClosed ? (t.avgExitPrice||t.entryPrice) : (t.livePrice || t.entryPrice);
                    
                    let pl = isLong ? (cur - t.entryPrice) * t.qty : (t.entryPrice - cur) * t.qty;
                    let plPct = t.entryPrice ? (isLong 
                        ? ((cur - t.entryPrice) / t.entryPrice) * 100 
                        : ((t.entryPrice - cur) / t.entryPrice) * 100) : 0;

                    const d1 = new Date(t.date);
                    const d2 = isClosed && t.exitDate ? new Date(t.exitDate) : new Date();
                    const days = !isNaN(d1) && !isNaN(d2) ? Math.max(0, Math.floor((d2 - d1) / (1000 * 60 * 60 * 24))) : 0;

                    let heatDollar = Math.abs(t.entryPrice - (t.stopLoss||t.entryPrice)) * t.qty;
                    let heatPct = currentEquity > 0 ? (heatDollar / currentEquity) * 100 : 0;
                    let totalRisk = heatDollar;
                    let rr = totalRisk > 0 ? (pl / totalRisk).toFixed(2) : 0;
                    let sizePct = currentEquity > 0 ? ((t.entryPrice * t.qty) / currentEquity) * 100 : 0;

                    if (isClosed) {
                        if (pl > 0) statWins.push({pl, days, plPct});
                        else statLosses.push({pl, days, plPct});
                    }

                    return `
                    <tr class="border-b border-gray-800 text-xs transition ${isClosed ? 'opacity-50 hover:opacity-100' : 'hover:bg-gray-800/50'}">
                        <td class="p-3 font-bold text-blue-400">
                            ${t.symbol} 
                            <span class="text-[9px] ${!isLong ? 'text-red-400':'text-green-400'} block">${t.direction || 'Long'}</span>
                        </td>
                        <td class="p-3 hidden sm:table-cell text-gray-500">${t.date ? t.date.substring(5,10) : 'N/A'}</td>
                        <td class="p-3 font-mono">${t.entryPrice}</td>
                        <td class="p-3 font-mono text-gray-400">${t.stopLoss}</td>
                        <td class="p-3 font-mono ${isClosed ? 'text-gray-500' : 'text-white'}">
                            ${cur.toFixed(2)}
                        </td>
                        <td class="p-3">${t.qty}</td>
                        <td class="p-3 hidden md:table-cell text-orange-300">${isClosed ? '-' : sizePct.toFixed(1)+'%'}</td>
                        <td class="p-3 font-bold ${pl >= 0 ? 'text-green-500':'text-red-500'}">$${pl.toFixed(0)}</td>
                        <td class="p-3 ${plPct >= 0 ? 'text-green-500':'text-red-500'}">${plPct.toFixed(1)}%</td>
                        <td class="p-3 hidden lg:table-cell text-gray-400">${isClosed ? '-' : heatPct.toFixed(1)+'%'}</td>
                        <td class="p-3 hidden lg:table-cell font-bold">${rr}</td>
                        <td class="p-3 hidden lg:table-cell">${days}d</td>
                        <td class="p-3 hidden lg:table-cell max-w-[100px] truncate" title="${t.notes}">${t.notes}</td>
                        <td class="p-3 flex gap-1">
                            ${!isClosed ? `<button onclick="openManage('${t.id}')" class="text-blue-400 p-1 hover:bg-gray-700 rounded"><i data-lucide="scissors" size="14"></i></button>` : ''}
                            <button onclick="openEdit('${t.id}')" class="text-gray-400 p-1 hover:bg-gray-700 rounded"><i data-lucide="edit-3" size="14"></i></button>
                            ${t.entryImage ? `<button onclick="showImage('${t.entryImage}')" class="text-orange-400 p-1 hover:bg-gray-700 rounded"><i data-lucide="image" size="14"></i></button>` : ''}
                            ${t.exitImage ? `<button onclick="showImage('${t.exitImage}')" class="text-purple-400 p-1 hover:bg-gray-700 rounded"><i data-lucide="flag" size="14"></i></button>` : ''}
                        </td>
                    </tr>`;
                } catch (e) { return ''; }
            }).join('');

            document.getElementById('tradeTable').innerHTML = rows;

            // Stats
            const nWins = statWins.length;
            const nLoss = statLosses.length;
            const totalCount = nWins + nLoss;
            const avgWin = nWins ? statWins.reduce((a,b)=>a+b.pl,0)/nWins : 0;
            const avgLoss = nLoss ? statLosses.reduce((a,b)=>a+b.pl,0)/nLoss : 0;
            const avgHoldWin = nWins ? statWins.reduce((a,b)=>a+b.days,0)/nWins : 0;
            const avgHoldLoss = nLoss ? statLosses.reduce((a,b)=>a+b.days,0)/nLoss : 0;
            const maxWin = nWins ? Math.max(...statWins.map(x=>x.pl)) : 0;
            const maxLoss = nLoss ? Math.min(...statLosses.map(x=>x.pl)) : 0;
            const rrr = avgLoss !== 0 ? Math.abs(avgWin / avgLoss).toFixed(2) : "0.00";
            const avgWinPct = nWins ? statWins.reduce((a,b)=>a+b.plPct,0)/nWins : 0;
            const avgLossPct = nLoss ? statLosses.reduce((a,b)=>a+b.plPct,0)/nLoss : 0;

            document.getElementById('statEquity').innerText = `$${currentEquity.toLocaleString(undefined, {maximumFractionDigits:0})}`;
            document.getElementById('statBalance').innerText = `Cash: $${cash.toLocaleString(undefined, {maximumFractionDigits:0})}`;
            document.getElementById('statOpenPL').innerText = `$${totalOpenALL.toFixed(2)}`;
            document.getElementById('statOpenPL').className = totalOpenALL >= 0 ? 'text-2xl font-bold text-green-500' : 'text-2xl font-bold text-red-500';
            const heatPctTotal = currentEquity > 0 ? (totalOpenHeatDollars / currentEquity) * 100 : 0;
            document.getElementById('statHeat').innerHTML = `<span class="text-red-400">$${totalOpenHeatDollars.toFixed(0)}</span> <span class="text-gray-500 text-sm">(${heatPctTotal.toFixed(1)}%)</span>`;
            document.getElementById('statExp').innerText = currentEquity > 0 ? ((totalExp/currentEquity)*100).toFixed(1) + '%' : '0%';
            
            document.getElementById('advRRR').innerText = rrr;
            document.getElementById('advAvgWin').innerText = `$${avgWin.toFixed(0)}`;
            document.getElementById('advAvgLoss').innerText = `$${avgLoss.toFixed(0)}`;
            document.getElementById('advMaxWin').innerText = `$${maxWin.toFixed(0)}`;
            document.getElementById('advMaxLoss').innerText = `$${maxLoss.toFixed(0)}`;
            document.getElementById('advCount').innerText = totalCount;
            document.getElementById('advHoldWin').innerText = avgHoldWin.toFixed(1) + 'd';
            document.getElementById('advHoldLoss').innerText = avgHoldLoss.toFixed(1) + 'd';

            const winRate = totalCount > 0 ? ((nWins/totalCount)*100).toFixed(2) : "0.00";
            const lossRate = totalCount > 0 ? ((nLoss/totalCount)*100).toFixed(2) : "0.00";
            
            document.getElementById('txtWinRate').innerText = `${winRate}%`;
            document.getElementById('txtLossRate').innerText = `${lossRate}%`;
            document.getElementById('txtAvgWinPct').innerText = `${avgWinPct.toFixed(2)}%`;
            document.getElementById('txtAvgLossPct').innerText = `${avgLossPct.toFixed(2)}%`;
            document.getElementById('chartRRR').innerText = rrr;

            const ctx1 = document.getElementById('winLossChart').getContext('2d');
            const ctx2 = document.getElementById('avgRetChart').getContext('2d');
            
            if(winLossChart) winLossChart.destroy();
            if(avgRetChart) avgRetChart.destroy();

            const chartOpts = { cutout: '70%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } };

            winLossChart = new Chart(ctx1, { type: 'doughnut', data: { datasets: [{ data: [nWins, nLoss], backgroundColor: ['#22c55e', '#ef4444'], borderWidth: 0 }] }, options: chartOpts });

            let d2 = [Math.abs(avgWinPct), Math.abs(avgLossPct)];
            let c2 = ['#22c55e', '#ef4444'];
            if (d2[0] === 0 && d2[1] === 0) { d2=[1]; c2=['#334155']; }

            avgRetChart = new Chart(ctx2, { type: 'doughnut', data: { datasets: [{ data: d2, backgroundColor: c2, borderWidth: 0 }] }, options: chartOpts });

            lucide.createIcons();
        }

        window.saveSettings = async () => {
            const start = parseFloat(document.getElementById('setStart').value);
            const dep = parseFloat(document.getElementById('setDeposit').value) || 0;
            const withdr = parseFloat(document.getElementById('setWithdraw').value) || 0;
            const newAdj = (settings.adjustments || 0) + dep - withdr;
            await setDoc(doc(db, "settings", "config"), { startBalance: start, adjustments: newAdj });
            document.getElementById('setDeposit').value = ''; document.getElementById('setWithdraw').value = '';
            toggleModal('settingsModal');
        };

        window.refreshPrices = async () => {
            const btn = document.getElementById('refreshBtn');
            btn.innerText = 'Updating...';
            for(let t of trades) {
                if(t.status === 'Open') {
                    try {
                        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${t.symbol}&token=${FINNHUB_KEY}`);
                        const data = await res.json();
                        if(data.c) await updateDoc(doc(db, "trades", t.id), { livePrice: data.c });
                    } catch(e) {}
                }
            }
            btn.innerText = 'Live Prices';
        };

        window.toggleModal = (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
            el.classList.toggle('flex');
        };

        window.openEdit = (id) => {
            document.getElementById('editTradeId').value = id || '';
            document.getElementById('modalTitle').innerText = id ? 'Edit Trade' : 'New Trade';
            
            const delBtn = document.getElementById('modalDeleteBtn');
            if(id) delBtn.classList.remove('hidden');
            else delBtn.classList.add('hidden');

            if(id) {
                const t = trades.find(x=>x.id===id);
                document.getElementById('tSymbol').value = t.symbol;
                document.getElementById('tDirection').value = t.direction || 'Long';
                document.getElementById('tEntry').value = t.entryPrice;
                document.getElementById('tQty').value = t.qty;
                document.getElementById('tStop').value = t.stopLoss;
                document.getElementById('tNotes').value = t.notes || '';
                document.getElementById('tDate').value = t.date ? t.date.substring(0,10) : new Date().toISOString().substring(0,10);
            } else {
                ['tSymbol','tEntry','tQty','tStop','tNotes','tImage'].forEach(k=>document.getElementById(k).value='');
                document.getElementById('tDirection').value = 'Long';
                document.getElementById('tDate').value = new Date().toISOString().substring(0,10);
            }
            toggleModal('tradeModal');
        };

        window.openManage = (id) => {
            document.getElementById('manageId').value = id;
            document.getElementById('exitDate').value = new Date().toISOString().substring(0,10);
            toggleModal('partialModal');
        };

        window.openSettings = () => {
            document.getElementById('setStart').value = settings.startBalance;
            document.getElementById('totalAdjustments').innerText = settings.adjustments || 0;
            toggleModal('settingsModal');
        };

        window.showImage = (src) => {
            document.getElementById('lightboxImg').src = src;
            toggleModal('imageLightbox');
        };

        window.deleteTrade = async (id) => {
            if(confirm("Are you sure you want to delete this trade permanently?")) {
                await deleteDoc(doc(db, "trades", id));
                toggleModal('tradeModal');
            }
        };
        
        window.exportPDF = () => {
             const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
            doc.text(`Trading Journal - ${filterType}`, 14, 15);
            const data = getFilteredTrades().map(t => [t.date.substring(0,10), t.symbol, t.direction, t.entryPrice, t.status === 'Closed' ? (t.avgExitPrice||0) : (t.livePrice||0), t.qty]);
            doc.autoTable({ head: [['Date', 'Ticker', 'Dir', 'Entry', 'Exit/Last', 'Qty']], body: data, startY: 20 });
            doc.save("journal.pdf");
        }

        lucide.createIcons();
    </script>

    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; font-size: 14px; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 1rem; }
        .input-field { background: #0f172a; border: 1px solid #334155; color: white; padding: 0.5rem; border-radius: 0.375rem; width: 100%; }
        .stat-lbl { font-size: 10px; color: #94a3b8; font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .stat-val { font-size: 1.1rem; font-weight: bold; }
        .filter-btn { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: bold; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .calc-lbl { font-size: 10px; color: #64748b; font-weight: bold; }
        .calc-val { font-size: 12px; font-weight: bold; color: #f1f5f9; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-[1800px] mx-auto pb-20">

    <!-- HEADER -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="bar-chart-2" class="text-blue-500"></i> TraderPro <span class="text-xs bg-gray-800 px-2 rounded">v7</span></h1>
        <div class="flex gap-2">
            <button onclick="openSettings()" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-gray-300 flex items-center gap-2 text-xs font-bold uppercase"><i data-lucide="wallet" size="14"></i> Wallet</button>
            <button id="refreshBtn" onclick="refreshPrices()" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-blue-400 flex items-center gap-2 text-xs font-bold uppercase"><i data-lucide="refresh-cw" size="14"></i> Live Prices</button>
            <button onclick="exportPDF()" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-gray-300 flex items-center gap-2 text-xs font-bold uppercase"><i data-lucide="download" size="14"></i> PDF</button>
            <button onclick="openEdit()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white font-bold flex items-center gap-2 text-sm"><i data-lucide="plus" size="16"></i> New Trade</button>
        </div>
    </div>

    <!-- FILTERS -->
    <div class="flex flex-wrap gap-2 mb-6 items-center bg-gray-900 p-2 rounded-lg border border-gray-800">
        <span class="text-xs text-gray-500 font-bold mr-2">FILTERS:</span>
        <button id="btn-ALL" onclick="setFilter('ALL')" class="filter-btn bg-blue-600 text-white">All</button>
        <button id="btn-7D" onclick="setFilter('7D')" class="filter-btn text-gray-400 hover:bg-gray-800">7 Days</button>
        <button id="btn-30D" onclick="setFilter('30D')" class="filter-btn text-gray-400 hover:bg-gray-800">30 Days</button>
        <button id="btn-MTD" onclick="setFilter('MTD')" class="filter-btn text-gray-400 hover:bg-gray-800">MTD</button>
        <button id="btn-YTD" onclick="setFilter('YTD')" class="filter-btn text-gray-400 hover:bg-gray-800">YTD</button>
        <button id="btn-CUST_NUM" onclick="setFilter('CUST_NUM')" class="filter-btn text-gray-400 hover:bg-gray-800"># Trades</button>
        <button id="btn-CUST_DATE" onclick="setFilter('CUST_DATE')" class="filter-btn text-gray-400 hover:bg-gray-800">Custom Date</button>
        
        <div id="customNumInput" class="hidden"><input id="filterNum" type="number" placeholder="20" class="bg-gray-800 border border-gray-700 text-white px-2 py-1 text-xs rounded w-16" onchange="updateDashboard()"></div>
        <div id="customDateInputs" class="hidden flex gap-2">
            <input id="filterStart" type="date" class="bg-gray-800 border border-gray-700 text-white px-2 py-1 text-xs rounded" onchange="updateDashboard()">
            <input id="filterEnd" type="date" class="bg-gray-800 border border-gray-700 text-white px-2 py-1 text-xs rounded" onchange="updateDashboard()">
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-6 gap-4 mb-6">
        
        <!-- 1. LIVE PORTFOLIO -->
        <div class="lg:col-span-1 card space-y-3">
            <div><span class="stat-lbl">Equity</span><div id="statEquity" class="text-2xl font-bold">$0</div><div id="statBalance" class="text-xs text-gray-500">Cash: $0</div></div>
            <div><span class="stat-lbl">Open P/L</span><div id="statOpenPL" class="text-xl font-bold">$0</div></div>
            <div class="grid grid-cols-2 gap-2">
                <div><span class="stat-lbl">Heat (Risk)</span><div id="statHeat" class="font-bold text-lg">$0</div></div>
                <div><span class="stat-lbl">Exposure</span><div id="statExp" class="font-bold text-lg text-orange-400">0%</div></div>
            </div>
        </div>

        <!-- 2. FILTERED METRICS -->
        <div class="lg:col-span-2 card grid grid-cols-4 md:grid-cols-4 gap-4">
            <div class="text-center"><span class="stat-lbl">Trades</span><div id="advCount" class="stat-val">0</div></div>
            <div class="text-center"><span class="stat-lbl">RRR</span><div id="advRRR" class="stat-val text-blue-400">0</div></div>
            <div class="text-center"><span class="stat-lbl">Avg Win</span><div id="advAvgWin" class="stat-val text-green-400">$0</div></div>
            <div class="text-center"><span class="stat-lbl">Avg Loss</span><div id="advAvgLoss" class="stat-val text-red-400">$0</div></div>
            <div class="text-center"><span class="stat-lbl">Max Win</span><div id="advMaxWin" class="stat-val text-green-400">$0</div></div>
            <div class="text-center"><span class="stat-lbl">Max Loss</span><div id="advMaxLoss" class="stat-val text-red-400">$0</div></div>
            <div class="text-center"><span class="stat-lbl">Hold Win</span><div id="advHoldWin" class="stat-val">0d</div></div>
            <div class="text-center"><span class="stat-lbl">Hold Loss</span><div id="advHoldLoss" class="stat-val">0d</div></div>
        </div>

        <!-- 3. DUAL CHARTS -->
        <div class="lg:col-span-2 card flex flex-col items-center justify-center p-4">
            <div class="flex w-full justify-around mb-2">
                <div class="text-center w-1/2 font-bold text-[10px] text-gray-400 uppercase">Win/Loss Ratio</div>
                <div class="text-center w-1/2 font-bold text-[10px] text-gray-400 uppercase">Avg Win/Loss %</div>
            </div>
            <div class="flex w-full justify-around items-center gap-4">
                <div class="w-24 h-24"><canvas id="winLossChart"></canvas></div>
                <div class="w-24 h-24"><canvas id="avgRetChart"></canvas></div>
            </div>
            <div class="flex w-full justify-around mt-2 text-sm font-bold">
                <div class="text-center w-1/2">
                    <div class="text-green-500" id="txtWinRate">0%</div>
                    <div class="text-red-500" id="txtLossRate">0%</div>
                </div>
                <div class="text-center w-1/2">
                    <div class="text-green-500" id="txtAvgWinPct">0%</div>
                    <div class="text-red-500" id="txtAvgLossPct">0%</div>
                </div>
            </div>
            <div class="mt-4 bg-green-900/30 border border-green-800 px-6 py-1 rounded text-center">
                <span class="font-bold text-gray-400 text-xs mr-2">RRR</span>
                <span class="font-bold text-xl text-green-400" id="chartRRR">0.00</span>
            </div>
        </div>

        <!-- 4. POSITION CALCULATOR -->
        <div class="lg:col-span-1 card p-3 flex flex-col justify-between">
            <div class="font-bold text-xs text-gray-400 uppercase mb-2">Position Sizing</div>
            
            <!-- Standard Inputs -->
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input id="calcEntry" type="number" placeholder="Entry $" class="input-field text-xs" oninput="updateCalculator()">
                <input id="calcStop" type="number" placeholder="Stop $" class="input-field text-xs" oninput="updateCalculator()">
            </div>
            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-[10px] text-gray-500">Stop %:</span>
                <span id="calcSLPct" class="text-xs font-bold text-orange-400">0.00%</span>
            </div>
            
            <!-- Auto Table -->
            <table class="w-full text-right text-[10px] mb-3">
                <tr class="text-gray-500"><th>Risk</th><th>$ Risk</th><th>Shares</th></tr>
                <tr><td class="font-bold text-white">1.0%</td><td id="risk100" class="text-gray-300">0</td><td id="share100" class="text-blue-400 font-bold">0</td></tr>
                <tr><td class="font-bold text-white">0.5%</td><td id="risk050" class="text-gray-300">0</td><td id="share050" class="text-blue-400 font-bold">0</td></tr>
                <tr><td class="font-bold text-white">0.25%</td><td id="risk025" class="text-gray-300">0</td><td id="share025" class="text-blue-400 font-bold">0</td></tr>
            </table>

            <!-- Custom Sizing -->
            <div class="border-t border-gray-700 pt-2 space-y-2">
                <div class="flex justify-between items-center gap-2">
                    <input id="calcFixedRisk" type="number" placeholder="Fixed Risk $" class="input-field text-xs w-1/2" oninput="updateCalculator()">
                    <span id="resFixedRiskShares" class="text-xs font-bold text-blue-400 w-1/2 text-right">-</span>
                </div>
                <div class="flex justify-between items-center gap-2">
                    <input id="calcPosPct" type="number" placeholder="Pos Size %" class="input-field text-xs w-1/2" oninput="updateCalculator()">
                    <div class="w-1/2 text-right">
                        <div id="resPosPctShares" class="text-xs font-bold text-blue-400">-</div>
                        <div id="resPosPctAmt" class="text-[9px] text-gray-500"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="card !p-0 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse whitespace-nowrap">
                <thead class="bg-slate-800 text-gray-400 text-[10px] uppercase font-bold tracking-wider">
                    <tr>
                        <th class="p-3">Symbol</th>
                        <th class="p-3 hidden sm:table-cell">Date</th>
                        <th class="p-3">Entry</th>
                        <th class="p-3">Stop</th>
                        <th class="p-3">Last</th>
                        <th class="p-3">Qty</th>
                        <th class="p-3 hidden md:table-cell">Size</th>
                        <th class="p-3">P/L $</th>
                        <th class="p-3">P/L %</th>
                        <th class="p-3 hidden lg:table-cell">Heat %</th>
                        <th class="p-3 hidden lg:table-cell">R/R</th>
                        <th class="p-3 hidden lg:table-cell">Time</th>
                        <th class="p-3 hidden lg:table-cell">Notes</th>
                        <th class="p-3">Actions</th>
                    </tr>
                </thead>
                <tbody id="tradeTable"></tbody>
            </table>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- EDIT/NEW TRADE -->
    <div id="tradeModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg">
            <input type="hidden" id="editTradeId">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="font-bold text-lg">Trade Details</h2>
                <div class="flex gap-2">
                    <input type="date" id="tDate" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs text-white">
                    <select id="tDirection" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs">
                        <option value="Long">LONG ðŸŸ¢</option>
                        <option value="Short">SHORT ðŸ”´</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div><label class="stat-lbl">Symbol</label><input id="tSymbol" class="input-field uppercase" type="text"></div>
                <div><label class="stat-lbl">Quantity</label><input id="tQty" class="input-field" type="number"></div>
                <div><label class="stat-lbl">Entry Price</label><input id="tEntry" class="input-field" type="number" step="0.01"></div>
                <div><label class="stat-lbl">Stop Loss</label><input id="tStop" class="input-field" type="number" step="0.01"></div>
            </div>
            <div class="mb-3"><label class="stat-lbl">Entry Chart</label><input id="tImage" type="file" class="block w-full text-xs text-gray-400 mt-1 bg-gray-900 border border-gray-700 rounded p-1"></div>
            <div class="mb-4"><label class="stat-lbl">Notes</label><textarea id="tNotes" class="input-field h-16"></textarea></div>
            <div class="flex gap-2 items-center">
                <button id="saveTradeBtn" onclick="saveTrade()" class="flex-1 bg-blue-600 py-2 rounded font-bold">Save Record</button>
                <button onclick="toggleModal('tradeModal')" class="flex-1 bg-gray-700 py-2 rounded">Cancel</button>
                <button id="modalDeleteBtn" onclick="deleteTrade(document.getElementById('editTradeId').value)" class="bg-red-900/50 text-red-400 border border-red-900 px-3 py-2 rounded hidden hover:bg-red-900 hover:text-white transition"><i data-lucide="trash-2" size="16"></i></button>
            </div>
        </div>
    </div>

    <!-- MANAGE MODAL -->
    <div id="partialModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
        <div class="card w-80">
            <input type="hidden" id="manageId">
            <h3 class="font-bold mb-4 text-center">Close Position</h3>
            <label class="stat-lbl">Exit Date</label><input type="date" id="exitDate" class="input-field mb-2 text-white">
            <label class="stat-lbl">Exit Price</label><input type="number" id="exitPrice" class="input-field mb-2">
            <label class="stat-lbl">Shares to Close</label><input type="number" id="exitQty" class="input-field mb-3">
            <label class="stat-lbl">Exit Chart</label><input type="file" id="exitImageFile" class="block w-full text-xs text-gray-400 mb-4 bg-gray-900 border border-gray-700 rounded p-1">
            <button onclick="executeClose(false)" class="w-full bg-blue-900/50 text-blue-300 py-2 rounded font-bold mb-2">Partial Trim</button>
            <button onclick="executeClose(true)" class="w-full bg-red-600 text-white py-2 rounded font-bold mb-2">Full Close</button>
            <button onclick="toggleModal('partialModal')" class="w-full bg-gray-700 py-2 rounded mt-2">Cancel</button>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-sm">
            <h2 class="font-bold text-lg mb-4">Wallet Settings</h2>
            <div class="mb-4"><label class="stat-lbl">Initial Balance</label><input type="number" id="setStart" class="input-field"></div>
            <div class="grid grid-cols-2 gap-3 mb-4 p-3 bg-gray-900 rounded border border-gray-700">
                <div><label class="stat-lbl text-green-400">Deposit (+)</label><input type="number" id="setDeposit" class="input-field" placeholder="$0"></div>
                <div><label class="stat-lbl text-red-400">Withdraw (-)</label><input type="number" id="setWithdraw" class="input-field" placeholder="$0"></div>
                <div class="col-span-2 text-xs text-gray-500 text-center">Net Adjustments: <span id="totalAdjustments" class="text-white font-mono">0</span></div>
            </div>
            <div class="flex gap-2">
                <button onclick="saveSettings()" class="flex-1 bg-green-600 py-2 rounded font-bold">Update</button>
                <button onclick="toggleModal('settingsModal')" class="flex-1 bg-gray-700 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="imageLightbox" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[60] p-4 cursor-pointer" onclick="toggleModal('imageLightbox')">
        <img id="lightboxImg" src="" class="max-w-full max-h-[90vh] rounded shadow-2xl border border-gray-700">
    </div>

</body>
</html>
